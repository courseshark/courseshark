<div class="container">
	<div class="row">
		<div class="span3">
			<img src="<%=user.avatar(200)%>" alt="Profile Image" />
			<p><small>Change your avatar at <a href="https://gravatar.com" target="_blank">gravatar.com</a></small></p>
		</div>
		<div class="span6">
			<h1><%=user.name%></h1>
			<h3><%=user.year%><sup><%=numberize(user.year)%></sup> year</h3>
			<h3><%=user.major.name%> @ <%=user.school.abbr%></h3>
		</div>
		<div class="span3">
			<h1>Friends</h1>
			<h4>You have added <a href="/friends"><?php echo count($user->getFriendsIds())?> friends</a></h4>
			<button class="btn btn-success" onClick="openDialog('/social/friends/dialog').friendsSearch({next: addUsers})">Add Friends</button>
		</div>
	</div> <!-- /.row -->
	<!-- Settings -->
	<form class="form-horizontal" id="settings-form">
	
		<div class="page-header">
			<h1>Profile Settings</h1>
		</div>
	
		<div class="row">
			<div class="span8 offset2">
				<fieldset>
			    <legend>Basic Information</legend>
			    <div class="control-group">
			      <label class="control-label" for="fist_name">Name</label>
			      <div class="controls">
							<input type="text" class="input-xlarge" name="first_name" value="<?php echo $user->firstName?>" placeholder="First Name"/>
							<input type="text" class="input-xlarge" name="last_name"  value="<?php echo $user->lastName;?>" placeholder="Last Name"/>
			      </div>
			    </div>

					<div class="control-group">
			      <label class="control-label" for="email">Email</label>
			      <div class="controls">
							<input type="email" class="input-xlarge" name="email" value="<?php echo $user->email;?>" placeholder="Email"/>
			      </div>
			    </div>
				</fieldset>
			</div>
		</div><!-- /.row -->
		<div class="row">
			<div class="span8 offset2">
				<fieldset>
			    <legend>Password</legend>
	
					<div class="control-group">
			      <label class="control-label" for="email">Current</label>
			      <div class="controls">
							<input type="password" class="input-xlarge" name="current_password" value="" autocomplete="off"/>
			      </div>
			    </div>
	
					<div class="control-group">
			      <label class="control-label" for="new_password">New Password</label>
			      <div class="controls">
							<input type="password" class="input-xlarge" name="new_password" value="" autocomplete="off"/>
			      </div>
			    </div>

					<div class="control-group">
			      <label class="control-label" for="confirm_password">Confirm Password</label>
			      <div class="controls">
							<input type="password" class="input-xlarge" name="confirm_password" value="" autocomplete="off"/>
			      </div>
			    </div>
				</fieldset>
			</div>
		</div><!-- /.row -->
		<div class="row">
			<div class="span8 offset2">
				<fieldset>
			    <legend>School Information</legend>
		
					<div class="control-group">
			      <label class="control-label" for="school_id">School</label>
			      <div class="controls">
							<select name="school_id" id="school-change" class="input-xlarge">
							<?php foreach($schools as $school):?>
								<option value="<?php echo $school->id?>" <?php echo (($user->school_id == $school->id)?'selected':'');?>><?php echo $school->name?></option>
							<?php endforeach;?>	
							</select>
			      </div>
			    </div>
		
					<div class="control-group">
			      <label class="control-label" for="major_id">Major</label>
			      <div class="controls">
							<select name="major_id" id="major-change" class="input-xlarge">
								<option value="">Loading...</option>
							</select>
			      </div>
			    </div>
		
					<div class="control-group">
			      <label class="control-label" for="year">Year</label>
			      <div class="controls">
							<select name="year" id="year-change" class="input-xlarge">
								<option value="1" <?php echo $user->year==1?'selected':''?>>First Year (Freshman)</option>
								<option value="2" <?php echo $user->year==2?'selected':''?>>Second Year (Sophomore)</option>
								<option value="3" <?php echo $user->year==3?'selected':''?>>Third Year (Junior)</option>
								<option value="4" <?php echo $user->year==4?'selected':''?>>Fourth Year (Senior)</option>
								<option value="5" <?php echo $user->year==5?'selected':''?>>Fifth Year (Super-Senior)</option>
								<option value="6" <?php echo $user->year==6?'selected':''?>>6+ Years</option>
								<option value="7" <?php echo $user->year==7?'selected':''?>>Graduate Student</option>
							</select>
			      </div>
			    </div>
				</fieldset>
			</div><!-- /.row -->
		</div>
		<div class="row">
			<div class="span8 offset2">
				<fieldset>
			    <legend>Friend Settings</legend>
					<div class="control-group">
			      <label class="control-label" for="major_id">Auto Accept Friends</label>
			      <div class="controls">
							<label for="friend_accept_yes">
								<input type="radio" name="auto_accept_friends" value="true" id="friend_accept_yes" <?=$user->auto_accept_friends?'checked':''?>/>
								Yes, automatically accept friends when they add me.
							</label>
							<label for="friend_accept_no" >
								<input type="radio" name="auto_accept_friends" value="false"id="friend_accept_no" <?=$user->auto_accept_friends?'':'checked'?>/>
								No, I must manually confirm friends before they can see my information. 
							</label>
							<p class="help-block">Invitations set to you will be automatically accepted.</p>
			      </div>
			    </div>
		
					<div class="control-group">
			      <label class="control-label" for="major_id">Invite Emails</label>
			      <div class="controls">
							<label for="friend_email_yes">
								<input type="radio" name="can_email_friend_requests" value="true" id="friend_email_yes" <?=$user->can_email_friend_requests?'checked':''?>/>
								Yes, send me an email when users request me as a friend.
							</label>
							<label for="friend_email_no" >
								<input type="radio" name="can_email_friend_requests" value="false"id="friend_email_no" <?=$user->can_email_friend_requests?'':'checked'?>/>
								No, I would not like to receive emails when users request me as a friend.
							</label>
							<p class="help-block">Send me emails when friends want to add me.</p>
			      </div>
			    </div>
				
					<div class="form-actions">
						<a class="btn btn-large btn-primary submit">Save</a>
					</div>
			
				</fieldset>
			</div>
		</div><!-- /.row -->
		<!-- /.row -->
		
	</form>
	</div><!-- /.container -->

	<script>
		var current_school = <?php echo @$user->school_id?>,
				current_major  = <?php echo $user->major_id?>;
		$('#school-change').bind('change', updateMajors);
		function updateMajors(){
			var k = $('#school-change').val(),
				$s = $('#major-change').empty();
			$.ajax({url: '/school/'+k+'/majors',dataType: 'json',
					success: function(j){
						r = j.message;for(i in r){$s.append($('<option>', { value : r[i].id, selected:(r[i].id==current_major)}).text(r[i].name));}}
			});
		}
		updateMajors();
		
		
		function submit_change(){
			data = $('form#settings-form').serialize();
			console.log(data);
			$.ajax({
				url:'/account/settings',
				data: data,
				type:'POST',
				dataType: 'json',
				success: function(result){
					if ( result.success == false )
					{
						show_timed_error(result.message+'<br /><small>'+result.information+'</small>');
					}
					else
					{
						$('input[name="current_password"]').val('');
						$('input[name="new_password"]').val('');
						$('input[name="confirm_password"]').val('');
						show_timed_message(result.message+'<br /><small>'+result.information+'</small>');
					}	
					$('html, body').animate({scrollTop:0}, 'fast');
				}
			});
		}
		$('.submit').click(function(){
			if ( $('#school-change').val() != current_school ){
				confirmDialog('<h4>Your school has changed!</h4><br /><p>If you continue all your previously <strong>saved schedules and caffeine notifications will be </strong>removed permanently!</strong> Are you sure you want to change schools?</p>', 'dialog_close();submit_change();current_school=$(\'#school-change\').val();localStorage.clear();','dialog_close();');
			}else{
				submit_change();
			}
			return;
		});
		
		$('select#school-change').qtip({
			content: '<h4>WARNING</h4><div align="center">By changing your school, all saved schedules and caffeine notifications will be removed!</div>',
			show: 'focus',
			hide: 'blur',
			position: {
		   		corner: {
		         	target: 'rightMiddle',
		         	tooltip: 'leftMiddle'
		      	},
				adjust: { 
					x: 23, 
					y: 0 
				}
		   	},
			style: {
				tip: 'leftMiddle',
				textAlign: 'center',
				name: 'red'
			},
			title: {
				text: '::Warning::',
				button:false
			}
		});
		function showSchoolDialog() {
			openDialog('/account/set-school').on('hidden', function(){setTimeout(showSchoolDialog, 1000)});
		}
		if ( window.school === 0 ){
			showSchoolDialog();
		}
	</script>