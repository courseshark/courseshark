tmp



	<script type="text/javascript">

		function showCreateNotification(){
			$('#new-notification').slideToggle('slow');
		}

		//Success handlers
		var purchaseThisSuccessHandler = function(purchaseAction){

			purchaseAction.response = purchaseAction.response?purchaseAction.response:{orderId:''};
			_gaq.push(['_trackEvent', 'PurchaseNotification', 'Success', 'FromForm']);

			$.ajax({
			  	url: '/transactions/confirm',
			  	data: {'orderId': purchaseAction.response.orderId},
					method: 'POST',
			  	success: function(j) {
					if ( j.success )
						create_new($('form#new-notification-form'));
					else
						errorDialog('We cannot validate your purchase. Please contact us at <a href="mailto:support@courseshark.com">support@courseshark.com</a> to remedy this issue.');
				},
			  	dataType: 'json'
			});
		}
		var purchaseSuccessHandler = function(purchaseAction){
			
			purchaseAction.response = purchaseAction.response?purchaseAction.response:{orderId:''};
			
			_gaq.push(['_trackEvent', 'PurchaseNotification', 'Success', 'Credit']);
			
			$.ajax({
			  	url: '/transactions/confirm',
			  	data: {'orderId': purchaseAction.response.orderId},
				method: 'POST',
			  	success: function(j) {
					if ( j.success ){
						$('#number-of-credits').fadeOut(function(){
							$(this) .html(''+(parseInt($('#number-of-credits').html())+1))
									.fadeIn();
						});
						showCreateNotification('single');
					}else{
						errorDialog('We cannot validate your purchase. Please contact us at <a href="mailto:support@courseshark.com">support@courseshark.com</a> to remedy this issue.');
					}
				},
			  	dataType: 'json'
			});
		}	

		//Failure handler
		var purchaseThisFailureHandler = function(purchaseActionError){
			_gaq.push(['_trackEvent', 'PurchaseNotification', 'Abandon', 'FromForm']);
		   	if (window.console != undefined) {
		    	console.log("Purchase did not complete.", purchaseActionError);
		  	}
		}
		var purchaseFailureHandler = function(purchaseActionError){
			_gaq.push(['_trackEvent', 'PurchaseNotification', 'Abandon', 'Credit']);
		   	if (window.console != undefined) {
		    	console.log("Purchase did not complete.", purchaseActionError);
		  	}
		}


		function purchase(what){
			generatedJwt = "<%= $singleToken; %>";
			if ( what == 'form-notification' ){
				_gaq.push(['_trackEvent', 'PurchaseNotification', 'Start', 'FromForm']);
				goog.payments.inapp.buy({
					'jwt'     : generatedJwt,
					'success' : purchaseThisSuccessHandler,
					'failure' : purchaseThisFailureHandler
				});
			}else{
				_gaq.push(['_trackEvent', 'PurchaseNotification', 'Start', 'Credit']);
				goog.payments.inapp.buy({
					'jwt'     : generatedJwt,
					'success' : purchaseSuccessHandler,
					'failure' : purchaseFailureHandler
				});
			}
			return;
		}




	</script>